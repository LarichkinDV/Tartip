# ARCHITECTURE.md
**Компонент отбора элементов ИМОКС и формирования промежуточных итогов для подготовки ВОР**  
Версия: 1.0  
Автор: Дмитрий <Фамилия>  
Дата: <дата>

## 1. Цель и контекст
Компонент автоматизирует подготовку ведомости объёмов работ (ВОР) из выгрузки ИМОКС для последующей привязки к ГЭСН/ФСНБ-2022 и загрузки в сметную систему («ГрандСмета»).  
Текущая реализация — VBA-макрос в Excel (Windows/macOS). Архитектура описывает **модули, их границы, контракты и потоки**, чтобы обеспечить повторяемость, расширяемость и будущую миграцию в сервис/библиотеку.

---

## 2. Функциональная декомпозиция

### 2.1 Модули и ответственность
- **Environment & Safety**
  - Управление `ScreenUpdating/Calculation/Events`.
  - `PrepareForSort` — безопасная подготовка листа: снять AutoFilter/Outline, чтобы сортировка не падала.

- **Schema & Columns**
  - `HeaderResolver` — нормализация заголовков (`NormHeader`), поиск обязательных/опциональных полей.
  - `EnsureNewCount` — создание `New_Count : Double` (если нет), вставка перед `Volume : Double` и инициализация `1` в строках-данных.
  - `ColumnVisibility` — whitelisting отображаемых столбцов + принудительное отображение всех `new_*`.

- **Filter Engine**
  - `TypePresenceFilter` — удаление строк с пустым `Type Name : String`.
  - `StageFilter` — пропуск только пар стадий:
    - (Демонтаж, Существующие) → StageCode=1
    - (None, Новая конструкция) → StageCode=2

- **Sort Engine**
  - Построение ключей: `StageCode`, `NameKey` (lower(trim(Type))), `Bucket`, `Flag(Itogo=0/Data=1)`.
  - Сортировка листа через `Worksheet.Sort` по `(StageCode ↑, NameKey ↑, Bucket ↑)`.

- **Bucket Engine**
  - `AreaBucket` — корзины площади **только** для типа:
    `(потолок)_жилье_натяжной.отм.3м_толщ=5мм`
    - 1: `<10`; 2: `>10 & <50`; 3: `>50`; строгие границы с EPS=5e-7.

- **Aggregation Engine**
  - Группировка по ключу `(Type, StageCode, Bucket)`.
  - Суммирование: `New_Count, Volume, Area, Length, Perimeter, Unconnected Height`.
  - Прочие (в т.ч. несуммируемые `*: Double`) — уникальное объединение через `;`.
  - Спец-правило: если итог по несуммируемой `*: Double` — **один числовой токен**, записать **как число** (с форматами).

- **Write-Back & Idempotency**
  - Поиск/вставка строки «Итого» **над** первой строкой группы.
  - Обновление без дублирования существующих «Итого».
  - Столбцы `new_*` (кроме служебного `New_Count`) **не перезаписываются**.

- **Outline Builder**
  - Группировка строк данных под «Итого» (`SummaryRow = xlAbove`).

- **Reporting**
  - Итоговый MessageBox: число отобранных элементов и число групп («Итого»).

---

## 3. Потоки (данные и управление)

### 3.1 Data-flow (высокоуровневый)
```mermaid
flowchart TD
  A[Выгрузка Excel] --> B[HeaderResolver<br/>EnsureNewCount]
  B --> C[ColumnVisibility]
  C --> D[Filter Engine<br/>(Пустой Type / Пары стадий)]
  D --> E[PrepareForSort]
  E --> F[Sort Engine<br/>(Stage→Name→Bucket→Flag)]
  F --> G[Aggregation Engine<br/>(Sum / Unique join)]
  G --> H[Write-Back & Idempotency]
  H --> I[Outline Builder]
  I --> J[ВОР с итогами]
```

### 3.2 Sequence-flow (упрощённый сценарий запуска)
```
sequenceDiagram
  participant U as User
  participant X as Excel Sheet
  participant M as Macro
  U->>M: Запуск MakeSubtotals_Configurable
  M->>X: Read headers, UsedRange
  M->>X: EnsureNewCount (insert/init)
  M->>X: ApplyColumnVisibility (show whitelist+new_*)
  M->>X: Filter (delete non-matching rows)
  M->>X: PrepareForSort (clear filters/outline)
  M->>X: Sort by Stage, Name, Bucket
  M->>X: Aggregate groups, write/update "Итого"
  M->>X: Build outline (summary above)
  M->>U: MsgBox: selected count & groups count
```
## 4. Контракты модулей (интерфейсы)
| Модуль/Функция                             | Вход                    | Выход                                  | Побочные эффекты                                   | Ошибки/валидация                                                |
| ------------------------------------------ | ----------------------- | -------------------------------------- | -------------------------------------------------- | --------------------------------------------------------------- |
| `HeaderResolver` (`FindHeader/NormHeader`) | Лист, строка заголовков | Индексы колонок, нормализованные имена | —                                                  | Отсутствие обязательных → ошибка                                |
| `EnsureNewCount`                           | Лист, индекс `Volume`   | Индекс `New_Count`                     | Может вставить столбец и заполнить значения        | —                                                               |
| `ColumnVisibility`                         | Заголовки, whitelist    | —                                      | Скрывает/показывает колонки; `new_*` всегда видимы | —                                                               |
| `Filter Engine`                            | Строки данных           | —                                      | Удаляет строки не прошедшие фильтр                 | —                                                               |
| `PrepareForSort`                           | Лист                    | —                                      | Снимает фильтры/оутлайн                            | —                                                               |
| `Sort Engine`                              | Ключи сортировки        | —                                      | Проставляет служебные ключи и сортирует лист       | Ошибки сортировки при активном фильтре/оутлайне — предотвращены |
| `AreaBucket`                               | `Type`, `Area`          | `Bucket ∈ {0,1,2,3}`                   | —                                                  | EPS-устойчивость на 10/50                                       |
| `Aggregation Engine`                       | Группы строк            | Массивы сумм/текстов и флагов          | —                                                  | —                                                               |
| `Write-Back`                               | Группа + агрегаты       | Строка «Итого»                         | Вставка/обновление строк, числовые форматы         | Идемпотентность: не создаёт дубликатов                          |
| `Outline Builder`                          | Лист, позиции «Итого»   | —                                      | Создаёт группировки под «Итого»                    | —                                                               |
| `Reporting`                                | Счётчики                | —                                      | MsgBox                                             | —                                                               |

## 5. Ключи сортировки

StageCode ∈ {1,2,99}:
1 — (Демонтаж, Существующие), 2 — (None, Новая конструкция), 99 — резерв/Itogo-fallback.

NameKey = lower(trim(Type Name : String)).

Bucket ∈ {0,1,2,3}: (0 — нет корзины; 1 — <10; 2 — >10 & <50; 3 — >50).

Flag ∈ {0,1}: 0 — «Итого», 1 — данные (для позиционирования «Итого» над строками группы).

Сортировка листа: (StageCode ↑, NameKey ↑, Bucket ↑).

## 6. Корзины площади

Применяются только для Type Name : String =
(потолок)_жилье_натяжной.отм.3м_толщ=5мм.

Bucket 1: Area < 10 − EPS → метка (до 10м2)
Bucket 2: Area > 10 + EPS и < 50 − EPS → (от 10 до 50м2)
Bucket 3: Area > 50 + EPS → (от 50м2)
Bucket 0: иначе (в т.ч. 10/50 и «почти равно»).
EPS = 5e-7.

## 7. Агрегация и форматы (резюме)

Сумма: New_Count, Volume, Area, Length, Perimeter, Unconnected Height.
Если все значения пустые/0 (и правило пустоты включено) → итог пусто.
Иначе: Round(7) → snap-to-int (|x−round(x)|≤EPS).
Текстовое объединение: все прочие (в т.ч. несуммируемые *: Double) в уникальные токены через ;.
Если итог по несуммируемой *: Double — один числовой токен → записать числом (с форматами).
Форматы: целые — "0", дробные — "0.#######"; локальный разделитель уважается; хвостовые нули обрезаются.

## 8. Идемпотентность и политика перезаписи

«Итого» определяется ключом (Type, StageCode, Bucket) и обновляется при повторном запуске (не дублируется).
Столбцы, начинающиеся с new_ (кроме New_Count), не перезаписываются макросом.

## 9. Обработка ошибок и устойчивость

Проверка обязательных столбцов: при отсутствии → понятное сообщение с перечнем недостающих.
Сортировка при активных фильтрах/outline → модуль PrepareForSort их снимает.
Погрешности двоичной арифметики на границах 10/50 нивелируются EPS-логикой.
Любые исключения на запись форматирования не разрушают данные; подсказка пользователю (MsgBox).

## 10. Производительность и ёмкость

Минимизация обращения к ячейкам: агрегация в массивах, запись блоками.
На десятках тысяч строк — приемлемо; при сотнях тысяч рекомендуется миграция в сервисный слой.
Повторный запуск идемпотентен, что упрощает поэтапную обработку.

## 11. Миграция: целевая референс-архитектура
### 11.1 Слои

Core Library (Python/.NET):
normalize_headers(df), filter_rows(df), build_sort_keys(df), bucket_area(df),
aggregate(df), format_numbers(df), write_itogo(df).

Adapters:
Excel-Adapter (VSTO/.NET или Office.js) — маршалинг данных в/из DataFrame.
CLI (CSV/Parquet) для batch-обработки.
REST API (FastAPI/.NET Minimal API) для интеграций.

UI:
Excel Add-in или Web UI (управление правилами, предпросмотр групп, экспорт).

Data:
Подключаемые справочники ГЭСН/ФСНБ-2022 (версионирование, кэш).

### 11.2 Контракты Core (пример)
| Функция                       | Вход      | Выход                | Замечания                                     |
| ----------------------------- | --------- | -------------------- | --------------------------------------------- |
| `normalize_headers(df)`       | DataFrame | DataFrame            | Приводит имена к канону (см. DATA_SCHEMAS.md) |
| `filter_rows(df)`             | DataFrame | DataFrame            | Удаляет неподходящие строки                   |
| `build_sort_keys(df)`         | DataFrame | DataFrame            | Добавляет `StageCode/NameKey/Bucket/Flag`     |
| `bucket_area(df)`             | DataFrame | DataFrame            | Строгие корзины для спец-типа                 |
| `aggregate(df)`               | DataFrame | (groups, aggregates) | Возвращает структуры для записи «Итого»       |
| `write_itogo(df, aggregates)` | DataFrame | DataFrame            | Вставка/обновление «Итого», правила формата   |

### 11.3 Пример REST API

POST /v1/aggregate — принимает табличные данные (CSV/JSON), возвращает агрегат + «Итого».
POST /v1/validate — проверка схем и обязательных столбцов.
POST /v1/preview — предпросмотр групп/корзин/итогов без записи.

### 11.4 Безопасность/IP

Код библиотеки хранится в отдельном приватном репозитории.
Этот репозиторий содержит только документацию и спецификации интерфейсов.

## 14. История версий

1.0 — первичная фиксация архитектуры VBA-реализации и карты миграции в сервис.
