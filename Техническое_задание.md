# Техническое задание на плагин ACBD для Autodesk Revit

## 1. Общие сведения
- **Название решения:** Плагин ACBD для расчёта стоимости и трудозатрат.
- **Среда выполнения:** Autodesk Revit с установленным pyRevit (ipy-движок).
- **Назначение:** автоматизация расчёта нормативной и опытной стоимости строительных элементов, а также подготовка отчётов по качеству данных ACBD.

## 2. Цели проекта
- Сократить трудозатраты инженеров-сметчиков и BIM-координаторов на пересчёт параметров ACBD.
- Обеспечить контроль полноты исходных данных и прозрачность результатов расчёта.
- Создать единое окно итогов, доступное для постоянного мониторинга в процессе моделирования.

## 3. Область применения и пользователи
- Отделы BIM и ПТО, работающие в Autodesk Revit.
- Инженеры-сметчики и специалисты по ценообразованию.
- Руководители проектов, контролирующие стоимость и трудозатраты.

## 4. Функциональные требования
### 4.1. Команда «Расчёт стоимости» (`CalculateCost.pushbutton`)
1. Предлагать пользователю диалог выбора области пересчёта:
   - «Вся модель» – обработка всех элементов разрешённых категорий.
   - «Видимые элементы» – обработка элементов, видимых в активном виде.
   - Флаг «Реконструкция» – ограничение расчёта стадиями «Демонтаж» и «Новые конструкции».
2. Обрабатывать категории Revit: стены, перекрытия, крыши, потолки, колонны, несущие конструкции, фундаменты, двери, окна, лестницы, ограждения, панели и стойки витражей, обобщённые модели.
3. Для каждого найденного экземпляра:
   - Определять тип и считывать типовые параметры ACBD: `ACBD_ЕдиницаИзмерения`, `ACBD_Н_ЦенаЗаЕдИзм`, `ACBD_Ф_ЦенаЗаЕдИзм`, `ACBD_Н_ТрудозатратыНаЕдИзм`, `ACBD_Ф_ТрудозатратыНаЕдИзм`.
   - Рассчитывать объём, площадь, длину или количество в зависимости от единицы измерения типа.
   - Пересчитывать и записывать экземплярные параметры: `ACBD_Н_СтоимостьЭлемента`, `ACBD_Ф_СтоимостьЭлемента`, `ACBD_Н_ТрудозатратыЭлемента`, `ACBD_Ф_ТрудозатратыЭлемента`.
   - Игнорировать элементы, для которых не удалось распознать единицу измерения или ставки.
4. Вести подсчёт агрегированных итогов по нормативной и опытной стоимости и трудозатратам.
5. Отображать/обновлять отдельное модельное окно «Стоимость объекта» с итогами и статистикой (количество обработанных, рассчитанных и пропущенных элементов, выбранная область расчёта).

### 4.2. Команда «Диагностика расчёта» (`CheckElements.pushbutton`)
1. Предлагать аналогичный диалог выбора области и режима реконструкции.
2. Выполнять расчёт по тем же правилам определения количеств и ставок без записи в модель.
3. Формировать структуру отчёта:
   - Сводка ключевых показателей (нормативная/опытная стоимость, нормативные/опытные трудозатраты, статистика обработки).
   - Детализация рассчитанных элементов по стадиям и типам с выводом параметров и ссылками на элементы Revit.
   - Детализация пропущенных элементов с указанием причин (пустая ЕИ, нераспознанная ЕИ, отсутствие ставок).
4. Отрисовывать HTML-отчёт в панели вывода pyRevit с интерактивными раскрывающимися блоками.
5. Предлагать пользователю сохранить XLSX-файл с тремя листами: итоги, рассчитанные элементы, пропущенные элементы. При успешном сохранении выводить подтверждение, при ошибке – текст ошибки.

## 5. Нефункциональные требования
- **Совместимость:** Autodesk Revit (версии, поддерживаемые установленным pyRevit), Windows 10/11.
- **Производительность:** обработка 10 000 элементов за один сеанс без заметного ухудшения отзывчивости интерфейса.
- **Надёжность:** транзакции Revit откатываются при отмене пользователем; ошибки выполнения перехватываются и выводятся в диалоговом окне.
- **Интерфейс:** окна должны открываться поверх Revit, не блокировать основную рабочую сессию и корректно отображать кириллицу.

## 6. Требования к данным
- Наличие на типах семейств параметров ACBD, перечисленных в разделе 4.
- Корректное заполнение стадий (фазы создания/демонтажа) для корректной фильтрации реконструкции.
- Настроенные форматы единиц измерения в соответствии с шаблонами ACBD.

## 7. Техническая реализация
- Язык: Python 2/3 через движок ipy pyRevit.
- Использование API Revit: `FilteredElementCollector`, `ElementMulticategoryFilter`, `UnitUtils`, `Transaction` и др.
- Интерфейс: элементы WPF (`Window`, `StackPanel`, `TextBlock`, `RadioButton`, `CheckBox`, `Button`).
- Работа с отчётами: HTML-рендер через `script.get_output()`, генерация XLSX путём записи минимального OpenXML.

## 8. Критерии приёмки
1. Корректное обновление экземплярных параметров ACBD при наличии ставок и распознанной единицы измерения.
2. Соответствие итоговых сумм значениям, рассчитанным вручную для контрольного набора данных.
3. Корректное отображение окна итогов и HTML-отчёта после запуска соответствующих команд.
4. Сохранение XLSX-файла с ожидаемой структурой и содержимым.
5. Успешная фильтрация элементов по стадиям при включённом режиме «Реконструкция».

## 9. Документация и обучение
- Руководство пользователя с описанием шагов запуска команд и структуры отчётов.
- Памятка по заполнению параметров ACBD и поддержке классификаторов единиц измерения.

## 10. Поддержка и развитие
- Логирование ошибок с помощью отчётов pyRevit для дальнейшего анализа.
- Возможность расширения списка категорий и единиц измерения без изменения архитектуры плагина.
