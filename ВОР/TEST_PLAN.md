# TEST_PLAN.md
**Тест-план для компонента отбора элементов ИМОКС и формирования промежуточных итогов (ВОР)**  
Версия: 1.0  
Автор: Дмитрий Ларичкин  
Дата: 29.09.2025

Связанные документы:  
- `TZ.md` — формальные требования  
- `ARCHITECTURE.md` — модули и потоки  
- `DATA_SCHEMAS.md` — схемы данных  
- `REPLICATION_GUIDE.md` — воспроизведение без исходников

---

## 1. Цель
Подтвердить, что реализация макроса (VBA/Excel, Win/macOS) соответствует требованиям:
- корректная фильтрация, сортировка, корзины площади, группировка;
- правила агрегации/округления/форматов;
- идемпотентность и защита `new_*`-колонок от перезаписи;
- стабильность/производительность на репрезентативных объёмах.

## 2. Область и критерии приёмки
**В Scope:** обработка таблиц Excel/CSV, создание `New_Count : Double`, удаление неподходящих строк, показ нужных столбцов, формирование строк «Итого», числовые форматы, Outline.  
**Out of Scope:** экспорт в «ГрандСмета», авто-подбор расценок.

**Критерии приёмки (высокоуровневые):**
1. Строки с пустым `Type Name : String` и неподдерживаемыми парами стадий удалены.  
2. Показаны только whitelist-колонки + все `new_*`; прочие скрыты.  
3. Сортировка: `StageCode ↑, NameKey ↑, Bucket ↑`; «Итого» над строками группы.  
4. Агрегация и форматы соответствуют `TZ.md §4.6–4.7`.  
5. Корзины площади корректны и **строги** на границах (10/50).  
6. Повторный запуск **обновляет** «Итого», не создавая дубликатов; `new_*` (кроме `New_Count`) не перезаписываются.  
7. Итоговое окно показывает количество отобранных элементов и число групп.

## 3. Окружение
- **Excel for Windows** (MS365/2021), **Excel for macOS** (MS365/2021).  
- Макросы включены; **без ActiveX** зависимостей (дружественно macOS).  
- Язык/локаль: RU; десятичный разделитель `,` и `.` (проверить оба варианта).  
- Кодировка: файлы в UTF-8 (подписи «Итого», метки стадий — кириллица).

## 4. Наборы тестовых данных
Подготовить `./samples/`:
- `tiny.xlsx` — 30–50 строк: все ветки логики (корзины, пустые, нестандартные заголовки).  
- `medium.xlsx` — 5–10 тыс. строк: замер производительности/устойчивость.  
- `locale_dot.xlsx` / `locale_comma.xlsx` — проверка разделителей.  
- `edge_headers.xlsx` — заголовки с NBSP, табами, двоеточиями, разным регистром.  
- `missing_required.xlsx` — отсутствие обязательной колонки.  
- `only_special_type.xlsx` — только `(потолок)_жилье_натяжной.отм.3м_толщ=5мм` c разными `Area`.  
- `new_prefix.xlsx` — несколько `new_*` колонок с заполненными значениями.  
- `pre_itogo_present.xlsx` — файл с уже созданными строками «Итого» (для идемпотентности).

Каждому файлу соответствует «ожидаемый» лист `expected_*` (скрин/xlsx) со ссылками на проверяемые ячейки.

## 5. Матрица тестов (сводная)
| ID | Категория | Цель | Вход | Ожидаемое |
|---|---|---|---|---|
| T01 | Валидация | Отсутствие обязательных колонок | `missing_required.xlsx` | Сообщение об ошибке с перечислением недостающих |
| T02 | Нормализация | Распознавание заголовков (пробелы/NBSP/табы/двоеточие) | `edge_headers.xlsx` | Колонки найдены; обработка продолжается |
| T03 | Фильтр типов | Удаление пустых `Type Name : String` | `tiny.xlsx` | Таких строк нет после обработки |
| T04 | Фильтр стадий | Оставить только (Демонтаж, Существующие) и (None, Новая конструкция) | `tiny.xlsx` | Прочие строки удалены |
| T05 | New_Count | Создание и инициализация `New_Count : Double` | `tiny.xlsx` без столбца | Столбец создан перед `Volume`, значения = 1 |
| T06 | Видимость | Показ whitelist + `new_*`, скрыть прочие | `tiny.xlsx` | Только перечисленные видимы |
| T07 | Сортировка | Stage→Name→Bucket; «Итого» над данными | `tiny.xlsx` | Порядок соответствует ключам |
| T08 | Корзины <10 | `Area<10−EPS` для спец-типа | `only_special_type.xlsx` | Bucket=1, метка `(до 10м2)` |
| T09 | Корзины (10) | `Area=10`/≈10 | `only_special_type.xlsx` | Bucket=0, метки нет |
| T10 | Корзины 10–50 | `>10+EPS & <50−EPS` | `only_special_type.xlsx` | Bucket=2, метка `(от 10 до 50м2)` |
| T11 | Корзины (50) | `Area=50`/≈50 | `only_special_type.xlsx` | Bucket=0, метки нет |
| T12 | Корзины >50 | `>50+EPS` | `only_special_type.xlsx` | Bucket=3, метка `(от 50м2)` |
| T13 | Суммы | Сумма по разрешённым `*: Double` | `tiny.xlsx` | Суммы в «Итого», прочие поля — не суммируются |
| T14 | Пустые суммы | Все значения пустые/0 → пустой итог | `tiny.xlsx` | Итоговая ячейка пуста (не 0,0000000) |
| T15 | Округление | 7 знаков, прилипание к целому | `tiny.xlsx` | `39,9999999999` → `40`; `130,0000002` → `130` |
| T16 | Форматы | Целые → `"0"`, дробные → `"0.#######"` | `locale_*` | нет «хвостов» нулей/висячего разделителя |
| T17 | Несуммир. Double | Один токен → число; несколько → текст | `tiny.xlsx` | `Thickness=40;40` → `40` (число); `40;45` → `"40;45"` |
| T18 | new_* защита | `new_*` не перезаписывать | `new_prefix.xlsx` | Значения `new_*` не изменились |
| T19 | Идемпотентность | Повторный запуск не дублирует «Итого» | `pre_itogo_present.xlsx` | Обновление значений; без новых строк |
| T20 | Outline | «Итого» сверху; данные сгруппированы под ним | `tiny.xlsx` | Группы уровня 2 сворачиваются/разворачиваются |
| T21 | Сообщение | Верные числа: отобрано N, групп G | любой | Соответствие фактическому N/G |
| P01 | Производительность | Время обработки medium.xlsx | `medium.xlsx` | Win/macOS ≤ целевого SLA (см. §8) |

## 6. Детализация ключевых тестов

### T02 — Нормализация заголовков
**Цель:** распознать колонки при «грязных» заголовках.  
**Вход:**  
- `Type  Name:String`, `Phase  Created:String`, ` Area:   Double `, табы/NBSP.  
**Шаги:** запустить макрос.  
**Ожидаемое:** нормализация до канона (`type name : string` и т.п.), отсутствие ошибок «Не найдены ключевые колонки».

### T07 — Сортировка и позиция «Итого»
**Цель:** порядок строк и место «Итого».  
**Шаги:** обработать `tiny.xlsx`, затем:  
1) проверить сортировку по `StageCode → NameKey → Bucket`;  
2) убедиться, что «Итого» стоит **над** первой строкой своей группы.

### T08–T12 — Корзины площади (строгие)
**Цель:** Bucket при разных `Area`.  
**Данные:** набор значений: `9.9999994`, `10`, `10.0000003`, `49.9999996`, `50`, `50.0000003`, `69`.  
**Ожидаемое:** см. матрицу (метки только для 1/2/3; ровно 10/50 → Bucket 0).

### T14 — Пустые суммы → пусто
**Цель:** не выводить `0,0000000`.  
**Данные:** группа, где все значения суммируемой колонки пусты/нули.  
**Ожидаемое:** итоговая ячейка очищена (пустая), NumberFormat не навязан.

### T15–T16 — Округление и формат
**Цель:** 7 знаков, прилипание, локаль.  
**Данные:** `39,9999999999`; `130,0000002`; `0,7500000`.  
**Ожидаемое:** `40`; `130`; `0,75` (или `0.75` при `.`), без хвостов нулей/висячих запятых.

### T17 — Несуммируемые `*: Double`
**Цель:** логика «число/текст».  
**Данные:** `Thickness` в группе = `40; 40; 40` → `40` (число) и `40; 45` → текст `"40;45"`.

### T18 — Защита `new_*`
**Цель:** неизменность пользовательских `new_*`.  
**Данные:** `new_custom_code`, `new_comment` заполнены разными значениями.  
**Ожидаемое:** после обработки значения **ровно те же**.

### T19 — Идемпотентность
**Цель:** повторный запуск без дублей.  
**Шаги:** запустить макрос 2 раза подряд на `pre_itogo_present.xlsx`.  
**Ожидаемое:** количество «Итого» не увеличится; их значения обновлены по текущим данным.

### T21 — Сообщение итогов
**Цель:** сверка чисел.  
**Шаги:** посчитать вручную/формулами число строк после удаления (N) и число уникальных групп (G); сопоставить с MsgBox.  
**Ожидаемое:** точное совпадение.

## 7. Методика проверки (мануал)
1. Откройте файл из `samples/`.  
2. Убедитесь, что макросы включены.  
3. Запустите `MakeSubtotals_Configurable`.  
4. После завершения:  
   - пройдитесь по чек-листу для соответствующего теста;  
   - сравните вид с `expected_*` (визуально и по точечным ячейкам);  
   - зафиксируйте результат (Pass/Fail) и замечания.  
5. Для T19 выполните повторный запуск и повторно проверьте.

## 8. Производительность (P01)
**Метрика:** время от запуска до появления MsgBox.  
**Целевое SLA (ориентир):**
- medium.xlsx (≈10k строк):  
  - Windows: ≤ 25 сек  
  - macOS: ≤ 40 сек  
Разница допустима из-за среды. Если ≥ SLA + 20%, записать как Warning и приложить лог размера входа/количества групп.

## 9. Регрессия
Перед публикацией/сборкой пакета запускать:  
- T02, T04, T07, T08–T12, T14–T19, T21, P01.  
Считается «зелёным», если нет Fail по критическим пунктам и не больше 2 Warning по перфоманс-границам.

## 10. Управление дефектами
**Шаблон карточки:**
- ID/Версия:  
- Файл/Набор данных:  
- Шаги воспроизведения:  
- Фактический результат:  
- Ожидаемый результат (ссылка на §TZ/§DATA_SCHEMAS):  
- Скрин/пример ячейки:  
- Локаль/ОС/Excel-версия:  
- Серьёзность: Blocker / Critical / Major / Minor.

**Классификация:**
- Blocker — падение, повреждение данных, дубли «Итого».  
- Critical — неверные суммы/корзины/форматы чисел.  
- Major — нарушение сортировки/Outline/MsgBox-счётчиков.  
- Minor — косметика, ширина столбцов, сообщение.

## 11. Трассировка требований → тесты
| Требование (TZ.md) | Тест(ы) |
|---|---|
| Обязательные колонки | T01, T02 |
| Фильтрация (пустые типы, стадии) | T03, T04 |
| Создание `New_Count` | T05 |
| Видимость колонок | T06 |
| Сортировка/позиция «Итого» | T07 |
| Корзины площади | T08–T12 |
| Суммирование/пустые итоги | T13, T14 |
| Округление/форматы | T15, T16 |
| Несуммируемые `*: Double` | T17 |
| Защита `new_*` | T18 |
| Идемпотентность | T19 |
| Outline | T20 |
| Сообщение метрик | T21 |
| Производительность | P01 |

## 12. Риски и смягчение
- **Локали**: отличия в разделителях → тесты `locale_*`.  
- **Большие данные**: Excel-ограничения → мониторить P01; при росте объёма предложить сервисную миграцию.  
- **Кодировка**: «Итого: …» и кириллица → хранить файлы в UTF-8, проверять на Win/macOS.

## 13. Подписи (sign-off)
- Разработчик/Автор: __________ Дата: __.__.____  
- Владелец продукта/Рук.: ______ Дата: __.__.____  
- QA/Ревьюер: ________________ Дата: __.__.____
