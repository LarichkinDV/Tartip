# TZ.md — Техническое задание
**Компонент отбора элементов ИМОКС и формирования промежуточных итогов для подготовки ВОР**  
Версия: 1.0  
Автор: Дмитрий Ларичкин  
Дата: 29.09.2025

## 0. Резюме
Компонент выполняет отбор и предобработку табличной выгрузки из информационной модели объекта капитального строительства (ИМОКС) для последующей привязки к расценкам ГЭСН/ФСНБ-2022 и формирования ведомости объёмов работ (ВОР), пригодной к загрузке в ПК «ГрандСмета» либо дальнейшей автоматизации расчёта сметы.

Основные функции:
- фильтрация строк по допустимым парам стадий;
- удаление «пустых» типов и любых строк, не прошедших отбор;
- нормализация видимости столбцов;
- безопасная сортировка и группировка;
- формирование строк «Итого» над каждой группой с суммированием числовых метрик и объединением текстов;
- специальное разбиение по корзинам площадей для одного заданного типа;
- числовое округление до 7 знаков с «прилипанием к целому», корректные форматы;
- идемпотентность: повторный запуск обновляет существующие «Итого», не создавая дубликатов;
- колонки, начинающиеся с `new_`, не перезаписываются (за исключением служебной `New_Count : Double`).

## 1. Термины и сокращения
- **ИМОКС** — информационная модель объекта капитального строительства.  
- **ВОР** — ведомость объёмов работ.  
- **Группа** — набор строк данных, объединённых по ключу (тип + стадия + корзина площади).  
- **Итого** — автоматически сформированная строка промежуточного итога над группой.  
- **Корзина площади** — подгруппа данных по диапазонам `Area : Double` для специального типа (см. §4.4).  
- **EPS** — эпсилон для сравнения чисел с целым и границами, по умолчанию `5e-7`.

## 2. Область применения и ограничения
- **Вход:** табличная выгрузка Excel/CSV с заголовками столбцов, перечисленными в §3.  
- **Выход:** тот же лист Excel с отфильтрованными данными, скрытыми «лишними» столбцами, отсортированными группами и добавленными/обновлёнными строками «Итого».  
- **Платформы:** Microsoft Excel для Windows и macOS (VBA).  
- **Вне рамок:** экспорт в «ГрандСмета», расчёт расценок — только подготовка агрегированной ВОР.

## 3. Входные данные: структура и требования

### 3.1 Обязательные столбцы
- `Type Name : String` — тип элемента (ключ группировки).  
- `Phase Demolished : String` — стадия демонтажа.  
- `Phase Created : String` — стадия создания.

> При отсутствии хотя бы одного — выполнение прекращается с сообщением об ошибке.

### 3.2 Опциональные столбцы
- `Area : Double` — используется для разбиения по диапазонам площади специально для заданного типа (см. §4.4). При отсутствии разбиение не выполняется.

### 3.3 Автоматически создаваемый столбец
- `New_Count : Double` — служебный счётчик.  
  - Если отсутствует, создаётся и вставляется **перед** столбцом `Volume : Double` (если `Volume` есть), иначе — добавляется в конец.  
  - Для всех строк-данных (не «Итого») заполняется `1`.  
  - Участвует в суммировании в строках «Итого».

### 3.4 Прочие поддерживаемые столбцы
Отображаемые (whitelist, если присутствуют):
ID; Type Name : String; Category : String; New_Count : Double; Volume : Double;
Area : Double; Length : Double; Width : Double; Phase Demolished : String;
Phase Created : String; Thickness : Double; Perimeter : Double;
Unconnected Height : Double; Height : Double
Любые столбцы, чьё имя начинается с `new_` (без учёта регистра), **всегда отображаются** и **не перезаписываются** значениями макроса (кроме служебного `New_Count : Double`). Остальные столбцы — скрываются.

## 4. Правила обработки данных

### 4.1 Фильтрация строк
Удаляются:
- строки, где `Type Name : String` пустой;
- строки, где пара стадий не входит в допустимые:
  1) `Phase Demolished = "Демонтаж"` **и** `Phase Created = "Существующие"` → **код стадии 1**;  
  2) `Phase Demolished = "None"` **и** `Phase Created = "Новая конструкция"` → **код стадии 2**.

Строки «Итого» распознаются по префиксу `Итого:` в `Type Name : String` и не рассматриваются как исходные данные.

### 4.2 Видимость столбцов
- Применяется whitelist из §3.4.  
- Все `new_*` — показываются.  
- Прочие — скрываются.

### 4.3 Сортировка (безопасная)
Перед сортировкой:
- снимаются фильтры и очищается группировка (outline) на листе.

Сортировка выполняется по ключам:
1. **Stage** (код стадии 1/2; иные — 99),  
2. **Name** (`Type Name : String`, регистр не учитывается),  
3. **Bucket** (корзина площади, см. §4.4; отсутствует — 0),  
и служебный **Flag** (Itogo=0, Data=1), чтобы «Итого» оказались над данными своей группы.

### 4.4 Разбиение по корзинам площади (только для спец-типа)
Для `Type Name : String` =  
`(потолок)_жилье_натяжной.отм.3м_толщ=5мм`  
включается разбиение по `Area : Double` на **строгие** диапазоны (ε = 5e-7):

- **Bucket 1:** `< 10` → метка в «Итого»: ` (до 10м2)`  
- **Bucket 2:** `> 10` **и** `< 50` → ` (от 10 до 50м2)`  
- **Bucket 3:** `> 50` → ` (от 50м2)`  
- Значения, равные 10 или 50 (а также «почти равные» в пределах EPS), **в корзины не попадают** (Bucket 0) и агрегируются вместе с типом **без** метки диапазона.

### 4.5 Группировка
Ключ группы:
(Type Name : String, StageCode, Bucket)
Строка «Итого» вставляется/обновляется **над** данными группы.

Заголовок «Итого»:
Итого: <Type Name> [<Демонтаж|Новая конструкция>]<метка диапазона, если Bucket∈{1,2,3}>
Примеры:
- `Итого: 2ПБ13-1 [Демонтаж]`  
- `Итого: (потолок)_жилье_натяжной.отм.3м_толщ=5мм [Новая конструкция] (от 10 до 50м2)`

### 4.6 Агрегация значений
**Суммируются:**  
`New_Count : Double`, `Volume : Double`, `Area : Double`, `Length : Double`, `Perimeter : Double`, `Unconnected Height : Double`.

Правила суммирования:
- если **все значения пустые/0** (и `TREAT_ZERO_AS_EMPTY = true`) — итоговая ячейка **очищается** (пусто);
- иначе итог — сумма, округлённая до 7 знаков, с «прилипанием к целому».

**Остальные поля** (включая `*: String` и **несуммируемые** `*: Double`, напр. `Thickness : Double`, `Height : Double`, `Width : Double`) агрегируются как **уникальные текстовые значения**, объединённые через `;`.

**Спец-правило для несуммируемых `*: Double` в «Итого»:**  
если после объединения получилось **ровно одно числовое значение**, итог записывается как **число** (с форматами §4.7); если значений несколько — остаётся **текст**, разделённый `;`.

### 4.7 Округление и числовые форматы
- Округление сумм — до **7 знаков**; затем «прилипание к целому»:
  - если `|x – round(x)| ≤ EPS` → итог = `round(x)`.
- Формат чисел:
  - целые → `"0"`;
  - дробные → `"0.#######"` (до 7 знаков, без «хвостов» нулей и без висящего разделителя).
- Для текстовых токенов чисел уважается локальный десятичный разделитель и удаляются хвостовые нули.

### 4.8 Повторный запуск (идемпотентность)
- Если строка «Итого» для ключа (Type, Stage, Bucket) уже существует — **перезаписываются только рассчитанные поля** согласно §4.6–§4.7.
- Столбцы, начинающиеся на `new_` (кроме системного `New_Count : Double`), **не перезаписываются**.

### 4.9 Сообщение по завершении
Показывается окно с метриками:
- количество **отобранных** элементов (после фильтрации и удаления);  
- число **сформированных/обновлённых** групп («Итого»).

## 5. Требования к производительности и совместимости
- Совместимость: Excel для Windows и macOS; без ActiveX-зависимостей (macOS-friendly).  
- Локали: корректная работа при десятичном `,` или `.`; токены чисел приводятся к локальному разделителю.  
- Производительность: алгоритм оперирует массивами и минимизирует обращение к ячейкам.  
- Ограничения: огромные файлы могут упираться в пределы Excel/VBA — рекомендуется последующая миграция в сервис.

## 6. Ошибки и уведомления
- Отсутствуют обязательные столбцы → критическая ошибка с перечислением недостающих.  
- Сортировка невозможна из-за активных фильтров/оутлайна → компонент автоматически снимает их перед сортировкой.  
- Прочие исключения VBA → останов с сообщением-подсказкой и ссылкой на «Как повторить».

## 7. Пользовательский сценарий
1) Открыть лист с данными (выгрузка ИМОКС).  
2) Запустить макрос «MakeSubtotals_Configurable».  
3) Дождаться окончания (видна сортировка, вставка «Итого», группировки).  
4) Проверить окно с итоговыми метриками.  
5) Просмотреть уровни группировок: на уровне 2 видны «Итого», раскрытие показывает строки группы.

## 8. Алгоритм (псевдокод)
```text
VALIDATE required columns: Type, Demol, Created
ENSURE New_Count column exists (insert before Volume if present); set = 1 for data rows

HIDE/SHOW columns per whitelist + always show new_*

FILTER rows:
  delete if Type empty
  delete if (Demol, Created) not in { ("Демонтаж","Существующие"), ("None","Новая конструкция") }

PREPARE_FOR_SORT: clear filters + clear outline

BUILD sort keys:
  StageCode := 1 | 2 | 99
  NameKey   := lower(trim(Type))
  Bucket    := if SpecialType(Type) and Area exists -> strict buckets; else 0
  Flag      := 0 for Itogo, 1 for Data

SORT by (StageCode, NameKey, Bucket)

AGGREGATE:
  groups keyed by (Type, StageCode, Bucket):
    sums for {New_Count, Volume, Area, Length, Perimeter, Unconnected Height}
    text-unique join for others (including non-sum *:Double)

WRITE Itogo row above first row of group:
  header := "Итого: <Type> [<Stage>] + bucket-label if any"
  for each column:
    if name starts with new_ and not New_Count -> do not overwrite
    else if in sum-set:
       if all empty/zeros -> clear
       else -> value := sum rounded to 7; snap-to-int; numeric format ("0"|"0.#######")
    else  // non-sum
       if column is *:Double AND unique-joined token is single number:
           write as NUMBER (rounded/snap/format)
       else
           write as TEXT (tokens joined by ";")

REBUILD outline: group data rows under each Itogo (summary above)

SHOW message: selected items count; groups count```

##9. Примеры
###9.1 Фильтрация по стадиям

Вход (фрагмент):
Type Name : String |	Phase Demolished : String |	Phase Created : String |	Area : Double
2ПБ13-1	           |  Демонтаж	           |  Существующие	             |  12
2ПБ13-1	           |  None	               |  Новая конструкция	         |  8
2ПБ13-1	           |  Ремонт	             |  Новая конструкция	         | 	10

Выход: остаются только первые две строки.

###9.2 Корзины площади (спец-тип)

Для (потолок)_жилье_натяжной.отм.3м_толщ=5мм:
- Area=9.999999 → Bucket 1 → метка (до 10м2)
- Area=10 → Bucket 0 (строгое правило)
- Area=49.9 → Bucket 2 → метка (от 10 до 50м2)
- Area=50 → Bucket 0 (строгое правило)
- Area=69 → Bucket 3 → метка (от 50м2)

###9.3 Несуммируемые *: Double (пример Thickess)

Если в группе Thickness : Double принимает значения 40; 40; 40 → итог 40 как число.
Если значения 40; 45 → итог "40;45" как текст.

##10. Критерии приёмки

При наличии обязательных столбцов макрос отрабатывает без ошибок; при отсутствии — выдаёт понятное сообщение.

После выполнения:
- удалены строки, не прошедшие фильтр;
- отобразились только whitelisted и new_* столбцы;
- сформированы/обновлены «Итого» над каждой группой;
- суммируемые поля агрегированы и отформатированы по §4.7;
- несуммируемые *: Double ведут себя по правилу «один токен → число, иначе → текст»;
- «Итого» идемпотентны (повторный запуск обновляет, не дублирует);
- окно метрик показывает количество отобранных элементов и число групп.

Корзины площади применены только к специальному типу и строго по §4.4.

##11. Риски и допущения

Большие файлы: возможны ограничения Excel/VBA по памяти/скорости.
Особые локали/форматы: поддержка , и . как разделителей; учёт «почти равных» граничных значений через EPS.
Excel-окружение: различия Win/macOS учтены (без ActiveX).

##12. План эволюции (за рамками ТЗ)

Вынос логики в библиотеку/сервис (Python/.NET) с REST-API.
Экспорт в «ГрандСмета» (XML/CSV) и привязка к ГЭСН/ФСНБ-2022.
Веб-интерфейс: визуализация групп и ручные правки до экспорта.
Интеграция LLM для авто-подбора расценок.

##13. История версий

1.0 — первичная фиксация reverse-engineered логики макроса (фильтрация, корзины, итоги, форматы, идемпотентность).
