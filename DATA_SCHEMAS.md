# DATA_SCHEMAS.md
**Схемы данных и формальные правила обработки**  
Версия: 1.0  
Автор: Дмитрий <Фамилия>  
Дата: <дата>

## 1. Термины
- **Header** — заголовок столбца (ячейка в строке 1).
- **NormHeader(s)** — нормализованное имя (см. §2.2) для сопоставления колонок.
- **Row** — строка данных (начиная со строки 2).
- **ItogoRow** — строка, у которой `Type Name : String` начинается с `Итого:` (служебная строка итога).
- **Bucket** — корзина площади для спец-типа (см. §6).
- **EPS** — эпсилон для сравнения чисел, по умолчанию `5e-7`.

---

## 2. Нормализация заголовков

### 2.1 Исходные особенности
В исходной выгрузке возможны:
- Несколько пробелов подряд, табы, **NBSP** (`Chr(160)`).
- Вариативные двоеточия и пробелы: `:`, ` :`, `: `, ` : `.
- Разный регистр символов.

### 2.2 Процедура нормализации `NormHeader(s)`
1. Удалить табы и NBSP → заменить на обычный пробел.
2. Обрезать крайние пробелы.
3. Сжать двойные пробелы до одного.
4. Унифицировать двоеточие: превратить любое встречающееся двоеточие и пробелы вокруг в шаблон ` ␣:␣ `.
5. Привести к нижнему регистру.

**Примеры:**
- `"Type  Name: String"` → `"type name : string"`
- `"Phase Created:String"` → `"phase created : string"`
- `"  Area:   Double  "` → `"area : double"`

> Все сопоставления имён колонок выполняются по `NormHeader`.

---

## 3. Состав полей

### 3.1 Обязательные (минимум для запуска)
| Поле (исходное имя) | NormHeader | Тип | Обязательность | Назначение |
|---|---|---|---|---|
| `Type Name : String` | `type name : string` | String | **Да** | Ключ типа/наименования элемента. |
| `Phase Demolished : String` | `phase demolished : string` | String | **Да** | Стадия демонтажа. |
| `Phase Created : String` | `phase created : string` | String | **Да** | Стадия создания. |

При отсутствии любого из обязательных полей — критическая ошибка, обработка не выполняется.

### 3.2 Опциональные / поддерживаемые
| Поле | NormHeader | Тип | Роль |
|---|---|---|---|
| `Area : Double` | `area : double` | Double | Используется для корзин площади спец-типа; при отсутствии корзины не применяются. |
| `Volume : Double` | `volume : double` | Double | Суммируется. |
| `Length : Double` | `length : double` | Double | Суммируется. |
| `Perimeter : Double` | `perimeter : double` | Double | Суммируется. |
| `Unconnected Height : Double` | `unconnected height : double` | Double | Суммируется. |
| `Width : Double` | `width : double` | Double | **Несуммируемое** `*: Double` → уникальные токены / «;». |
| `Thickness : Double` | `thickness : double` | Double | **Несуммируемое** `*: Double` → уникальные токены / «;». |
| `Height : Double` | `height : double` | Double | **Несуммируемое** `*: Double` → уникальные токены / «;». |
| `Category : String` | `category : string` | String | Текстовая агрегация (уникальные токены / «;»). |
| `ID` | `id` | String/Number | Текстовая агрегация (уникальные токены / «;»). **Не суммируется.** |
| Любой `new_*` | `new_*` | Any | Всегда отображать; **не перезаписывать** (кроме служебного `New_Count`). |

### 3.3 Автоматически создаваемое
| Поле | NormHeader | Тип | Создание | Роль |
|---|---|---|---|---|
| `New_Count : Double` | `new_count : double` | Double | Если отсутствует, вставляется **перед** `Volume : Double` (если есть), иначе в конец. Инициализируется `1` для всех строк-данных. | **Суммируется** в «Итого». |

---

## 4. Валидация строк

### 4.1 Удаление «пустых типов»
- Если `trim(Type Name : String)` пуст — строка **удаляется**.

### 4.2 Допустимые пары стадий (StageFilter)
Разрешены **только**:
1. `Phase Demolished = "Демонтаж"` **и** `Phase Created = "Существующие"` → `StageCode = 1`
2. `Phase Demolished = "None"` **и** `Phase Created = "Новая конструкция"` → `StageCode = 2`

Все прочие комбинации стадий — **удаляются**.

### 4.3 Строки «Итого»
Строки, где `Type Name : String` начинается с `Итого:`, считаются служебными и **не** участвуют как исходные данные.

---

## 5. Видимость столбцов
- **Whitelist** (если присутствуют в исходнике, показывать):  
  `ID; Type Name : String; Category : String; New_Count : Double; Volume : Double; Area : Double; Length : Double; Width : Double; Phase Demolished : String; Phase Created : String; Thickness : Double; Perimeter : Double; Unconnected Height : Double; Height : Double`
- Любые столбцы с префиксом `new_` — **всегда видны** и **не перезаписываются** логикой макроса (кроме `New_Count`).
- Остальные столбцы — скрываются.

---

## 6. Корзины площади (Area Buckets)

### 6.1 Применимость
Только для точного `Type Name : String`:
(потолок)_жилье_натяжной.отм.3м_толщ=5мм


### 6.2 Границы (строгие, с ε-защитой)
Пусть `x = Area`.

| Bucket | Условие | Метка в «Итого» |
|---:|---|---|
| 1 | `x < 10 - EPS` | `(до 10м2)` |
| 2 | `(x > 10 + EPS) AND (x < 50 - EPS)` | `(от 10 до 50м2)` |
| 3 | `x > 50 + EPS` | `(от 50м2)` |
| 0 | иначе (в т.ч. x≈10 или x≈50 в пределах EPS) | — |

`EPS = 5e-7`.

---

## 7. Ключи сортировки

### 7.1 Поля ключей
| Ключ | Обозначение | Диапазон | Описание |
|---|---|---:|---|
| StageCode | S | {1,2,99} | 1 — Демонтаж/Существующие; 2 — None/Новая конструкция; 99 — fallback |
| NameKey | N | string | `lower(trim(Type Name : String))` |
| Bucket | B | {0,1,2,3} | По §6; 0 — нет корзины |
| Flag | F | {0,1} | 0 — «Итого», 1 — данные (служит для позиционирования «Итого» над строками) |

### 7.2 Порядок сортировки листа
StageCode ↑, NameKey ↑, Bucket ↑

Перед сортировкой **всегда** снять AutoFilter и Outline.

---

## 8. Правила агрегации

### 8.1 Суммируемые колонки
Суммируются **только**:
New_Count : Double
Volume : Double
Area : Double
Length : Double
Perimeter : Double
Unconnected Height : Double


**Пустые итоги:** если для колонки в группе **все** значения пустые/0  
(при включённом правиле «0 как пусто») — итоговая ячейка остаётся **пустой**.

**Округление и прилипание:**
- Сумма → `Round(…, 7)` → если `|x − round(x)| ≤ EPS` → записать целое.
- Формат: целые → `"0"`, дробные → `"0.#######"`.

### 8.2 Несуммируемые колонки
- Все остальные поля (`*: String` и **несуммируемые** `*: Double`, напр. `Thickness`, `Height`, `Width`) агрегируются как **уникальные токены**, объединённые через `;`.
- Для колонок `*: Double` действует правило:
  - если итог **ровно один числовой токен** → записать **как число** (округление/прилипание/формат как выше);
  - если несколько токенов → записать **как текст** `"v1;v2;..."`.
- Текстовые численные токены приводятся к **локальному десятичному разделителю**, хвостовые нули удаляются, «висящий» разделитель убирается.

---

## 9. Формирование «Итого»

### 9.1 Ключ группы
GroupKey = (Type Name : String, StageCode, Bucket)

### 9.2 Заголовок строки «Итого»
"Итого: " + <Type Name : String> + " [" + <"Демонтаж"|"Новая конструкция"> + "]" + <BucketLabel?>

`BucketLabel` добавляется только для спец-типа (§6.1) и равен:  
` (до 10м2)` | ` (от 10 до 50м2)` | ` (от 50м2)`.

Строка «Итого» вставляется/обновляется **над** строками своей группы (идемпотентно: повторный запуск обновляет значения, не дублирует строку).

### 9.3 Политика перезаписи
- Столбцы с префиксом `new_` (кроме служебного `New_Count : Double`) **не перезаписываются**.
- Суммируемые — по §8.1; несуммируемые — по §8.2.

---

## 10. Локали и форматирование
- Десятичный разделитель берётся из системных настроек (`Application.International(xlDecimalSeparator)`).
- В текстовых числах используется локальный разделитель; хвостовые нули обрезаются.
- Числовые ячейки «Итого» форматируются:
  - целые → `"0"`;
  - дробные → `"0.#######"`.

---

## 11. Псевдосхема данных (JSON-подобно)
```json
{
  "row": {
    "Type Name : String": "string (required, non-empty)",
    "Phase Demolished : String": "\"Демонтаж\" | \"None\" | ... (required)",
    "Phase Created : String": "\"Существующие\" | \"Новая конструкция\" | ... (required)",
    "Area : Double": "number | null",
    "Volume : Double": "number | null",
    "Length : Double": "number | null",
    "Width : Double": "number | null",
    "Thickness : Double": "number | null",
    "Perimeter : Double": "number | null",
    "Unconnected Height : Double": "number | null",
    "Height : Double": "number | null",
    "Category : String": "string | null",
    "ID": "string | number | null",
    "New_Count : Double": "number (auto=1 for data rows)"
  },
  "constraints": {
    "required": [
      "Type Name : String",
      "Phase Demolished : String",
      "Phase Created : String"
    ],
    "validStagePairs": [
      ["Демонтаж", "Существующие"],
      ["None", "Новая конструкция"]
    ]
  },
  "aggregation": {
    "sum": [
      "New_Count : Double",
      "Volume : Double",
      "Area : Double",
      "Length : Double",
      "Perimeter : Double",
      "Unconnected Height : Double"
    ],
    "textUniqueJoin": "all others; for non-sum *: Double — single numeric token => write as number; else text"
  }
}
```

## 12. Примеры
### 12.1 Нормализация имён

Вход: " Phase Created:String " → NormHeader: "phase created : string"
Вход: "Area:Double" → "area : double"

### 12.2 Корзины площади (спец-тип)

Area = 9.9999994 → Bucket 1 ((до 10м2))
Area = 10.0000000 → Bucket 0 (ровно 10)
Area = 49.95 → Bucket 2 ((от 10 до 50м2))
Area = 50.0 → Bucket 0 (ровно 50)
Area = 50.01 → Bucket 3 ((от 50м2))

### 12.3 Несуммируемые *: Double

Значения в группе: 40; 40; 40 → итог 40 (число, формат "0").
Значения: 39.9999999999 → округление до 7 знаков → 40 (прилипание к целому).
Значения: 40; 45 → итог "40;45" (текст).

## 13. Критерии корректности схем

Обязательные поля присутствуют и непусты по своим правилам.
Все строки соответствуют StageFilter; прочие удалены.
Нормализация заголовков даёт устойчивое сопоставление колонок.
Корзины площади применены только к спец-типу и строго по §6.2.
Итоги формируются по ключу (Type, StageCode, Bucket) и записываются над группой.
Суммируемые поля — по §8.1; несуммируемые — по §8.2; форматы чисел соблюдены.
Столбцы new_* не перезаписываются; New_Count — управляется системой.

## 14. Связанные документы

TZ.md — техническое задание (правила и сценарии).
ARCHITECTURE.md — архитектура модулей и потоков.
TEST_PLAN.md — тест-кейсы и эталонные проверки.
REPLICATION_GUIDE.md — как воспроизвести логику без исходного кода.

## 15. История версий

1.0 — первичная фиксация схем и нормализации для текущего прототипа.
